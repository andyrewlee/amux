#!/usr/bin/env bash
set -euo pipefail

if [[ -n "${AMUX_SKIP_HARNESS:-}" ]]; then
  echo "amux pre-push: skipping harness (AMUX_SKIP_HARNESS set)"
  exit 0
fi

root="$(git rev-parse --show-toplevel)"
cd "$root"

center_args=(${AMUX_HARNESS_CENTER_ARGS:---mode=center --tabs=8 --frames=200 --warmup=20 --hot-tabs=1 --payload-bytes=128})

echo "amux pre-push: running headless UI harness (center)..."
go run ./cmd/amux-harness "${center_args[@]}"

echo "amux pre-push: running tests..."
go test ./internal/e2e
